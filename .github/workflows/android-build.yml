name: Android Build & Release

on:
  push:
    tags:
      - 'v*' # Triggert bei Tags wie v1.0.0, v1.2.3, etc.

jobs:
  build:
    name: Build & Release APK
    runs-on: ubuntu-latest

    steps:
      # ── 1. Repo klonen ──────────────────────────────────
      - name: Checkout Code
        uses: actions/checkout@v4

      # ── 2. Node.js Setup ────────────────────────────────
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'

      # ── 3. JDK Setup ────────────────────────────────────
      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      # ── 4. Dependencies installieren ────────────────────
      - name: Install Dependencies
        run: npm i

      # ── 5. Vue App bauen ────────────────────────────────
      - name: Build Vue App
        run: npm run build

      # ── 6. Capacitor sync ───────────────────────────────
      - name: Capacitor Sync
        run: npm run sync

      # ── 7. Gradle Permissions ───────────────────────────
      - name: Make Gradlew Executable
        run: chmod +x android/gradlew

      # ── 8a. Debug APK bauen (immer) ─────────────────────
      - name: Build Debug APK
        working-directory: android
        run: ./gradlew assembleDebug

      # ── 8b. Release APK bauen (nur wenn Keystore-Secrets vorhanden) ──
      - name: Decode Keystore
        if: ${{ secrets.KEYSTORE_BASE64 != '' }}
        run: echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > android/app/my-keystore.jks

      - name: Build Release APK
        if: ${{ secrets.KEYSTORE_BASE64 != '' }}
        working-directory: android
        run: |
          ./gradlew assembleRelease \
            -Pandroid.injected.invoked.from.ide=true \
            -PKEYSTORE_PATH=$(pwd)/app/my-keystore.jks \
            -PKEYSTORE_PASSWORD=${{ secrets.KEYSTORE_PASSWORD }} \
            -PKEY_ALIAS=${{ secrets.KEY_ALIAS }} \
            -PKEY_PASSWORD=${{ secrets.KEY_PASSWORD }}

      # ── 9. APK-Dateien sammeln ──────────────────────────
      - name: Collect APKs
        id: collect
        run: |
          DEBUG_APK=$(find android/app/build/outputs/apk/debug -name "*.apk" | head -1)
          echo "debug_apk=$DEBUG_APK" >> $GITHUB_OUTPUT

          RELEASE_APK=$(find android/app/build/outputs/apk/release -name "*.apk" 2>/dev/null | head -1)
          echo "release_apk=$RELEASE_APK" >> $GITHUB_OUTPUT

          if [ -n "$RELEASE_APK" ]; then
            echo "has_release=true" >> $GITHUB_OUTPUT
          else
            echo "has_release=false" >> $GITHUB_OUTPUT
          fi

      # ── 10. GitHub Release erstellen ────────────────────
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: |
            ## Release ${{ github.ref_name }}

            ### Download
            - **Debug APK** – zum Testen (nicht signiert)
            - **Release APK** – produktionsfertig (signiert) *(nur verfügbar, wenn Keystore konfiguriert)*

            ### Änderungen
            *(Hier deine Changelog-Einträge einfügen)*
          files: |
            ${{ steps.collect.outputs.debug_apk }}
          token: ${{ secrets.GITHUB_TOKEN }}

      # ── 11. Release APK anhängen (nur wenn vorhanden) ──
      - name: Attach Release APK
        if: steps.collect.outputs.has_release == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          files: |
            ${{ steps.collect.outputs.release_apk }}
          token: ${{ secrets.GITHUB_TOKEN }}